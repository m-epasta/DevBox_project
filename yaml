# devbox.yaml
# Run 'devbox init' to create this file automatically

name: "my-nextjs-app"
description: "E-commerce site with Next.js and PostgreSQL"
version: "1.0"

# Command definitions - used by 'devbox start'
commands:
  dev: "npm run dev"
  test: "npm test --watch"
  build: "npm run build"
  clean: "rm -rf node_modules .next"

# Services - automatically managed by 'devbox start'
services:
  database:
    command: "docker-compose up postgres"
    working_dir: "./infra"
    health_check:
      type: "port"
      target: 5432
    dependencies: []  # This service has no dependencies
    
  redis:
    command: "docker-compose up redis" 
    health_check:
      type: "port"
      target: 6379
    dependencies: []
    
  frontend:
    command: "npm run dev"
    health_check:
      type: "http"
      target: "http://localhost:3000/api/health"
    dependencies: ["database", "redis"]  # Needs db and redis first

# Environment variables - set when running commands
environment:
  DATABASE_URL: "postgres://localhost:5432/app"
  REDIS_URL: "redis://localhost:6379"
  NODE_ENV: "development"
  PORT: "3000"

# Hooks - run automatically during 'devbox start/stop'
hooks:
  pre_start: "npm install && npm run db:migrate"
  post_start: "echo 'ðŸš€ Application ready at http://localhost:3000'"
  pre_stop: "npm run db:backup"
  post_stop: "echo 'âœ… Application stopped'"

# Dependencies - checked by 'devbox start --validate'
dependencies:
  node: ">=18.0.0"
  docker: true
  ports: [3000, 5432, 6379]  # Ports that will be used

# Browser tabs - automatically opened by 'devbox start'
browser:
  - "http://localhost:3000"    # Main app
  - "http://localhost:3001"    # Storybook
  - "http://localhost:8080"    # Admin panel